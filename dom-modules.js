// Generated by CoffeeScript 1.4.0
(function() {
  var BaseModule, ModuleInfo, action, buildModule, genName, jqueryPlugin, lastNameId, moduleInstances, modules, modulesAPI,
    __slice = [].slice,
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  modules = {};

  moduleInstances = {};

  BaseModule = (function() {

    BaseModule.NAME = 'BaseModule';

    BaseModule.EVENT_PREFIX = 'base-module';

    BaseModule.DEFAULT_SETTINGS = {};

    BaseModule.ROOT_SELECTOR = null;

    BaseModule.ELEMENTS = {};

    BaseModule.INIT = 'none';

    BaseModule.EXPECTED_SETTINGS = [];

    function BaseModule(root, settings) {
      var data, option, _i, _len, _ref,
        _this = this;
      this.root = root;
      this.settings = $.extend({}, this.constructor.DEFAULT_SETTINGS);
      data = this.root.data();
      _ref = this.constructor.EXPECTED_SETTINGS;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        option = _ref[_i];
        if (data[option] !== void 0) {
          this.settings[option] = data[option];
        }
      }
      $.extend(this.settings, settings);
      this.root.data(this.constructor.NAME, this);
      this.updateTree();
      this.root.on('html-inserted', function() {
        return _this.updateTree();
      });
      if (moduleInstances[this.constructor.NAME] === void 0) {
        moduleInstances[this.constructor.NAME] = [];
      }
      moduleInstances[this.constructor.NAME].push(this);
      if (typeof this.initializer === "function") {
        this.initializer();
      }
    }

    BaseModule.prototype.updateTree = function() {
      var element, name, _ref, _results;
      _ref = this.constructor.ELEMENTS;
      _results = [];
      for (name in _ref) {
        element = _ref[name];
        if (!element.dynamic) {
          _results.push(this[name] = this.find(element.selector));
        }
      }
      return _results;
    };

    BaseModule.prototype.find = function() {
      var args, _ref;
      args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
      return (_ref = this.root).find.apply(_ref, args);
    };

    BaseModule.prototype.on = function() {
      var args, eventName, _ref;
      eventName = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      return (_ref = this.root).on.apply(_ref, [this.constructor.fixEventName(eventName)].concat(__slice.call(args)));
    };

    BaseModule.prototype.off = function() {
      var args, eventName, _ref;
      eventName = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      return (_ref = this.root).off.apply(_ref, [this.constructor.fixEventName(eventName)].concat(__slice.call(args)));
    };

    BaseModule.prototype.fire = function() {
      var args, eventName, _ref;
      eventName = arguments[0], args = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      return (_ref = this.root).trigger.apply(_ref, [this.constructor.fixEventName(eventName)].concat(__slice.call(args)));
    };

    BaseModule.prototype.setOption = function(name, value) {
      return this.settings[name] = value;
    };

    BaseModule.fixEventName = function(name) {
      return "" + this.constructor.EVENT_PREFIX + "-" + name;
    };

    return BaseModule;

  })();

  ModuleInfo = (function() {

    ModuleInfo.prototype._methods = null;

    ModuleInfo.prototype._rootSelector = null;

    ModuleInfo.prototype._elements = null;

    ModuleInfo.prototype._events = null;

    ModuleInfo.prototype._globalEvents = null;

    ModuleInfo.prototype._modulesEvents = null;

    ModuleInfo.prototype._init = null;

    ModuleInfo.prototype._defaultSettings = null;

    ModuleInfo.prototype._eventPrefix = null;

    function ModuleInfo(name) {
      this.name = name;
      this._methods = {};
      this._elements = {};
      this._events = {};
      this._globalEvents = {};
      this._modulesEvents = {};
      this._defaultSettings = {};
      this._expectedSettings = [];
      this._init = 'none';
    }

    ModuleInfo.prototype.methods = function(newMethods) {
      return $.extend(this._methods, newMethods);
    };

    ModuleInfo.prototype.init = function(value) {
      return this._init = value;
    };

    ModuleInfo.prototype.root = function(rootSelector) {
      return this._rootSelector = rootSelector;
    };

    ModuleInfo.selectorToName = function(selector) {
      var first, word;
      first = true;
      return ((function() {
        var _i, _len, _ref, _results;
        _ref = selector.split(/[^a-z0-9]+/i);
        _results = [];
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          word = _ref[_i];
          if (word !== '') {
            if (first) {
              first = false;
              _results.push(word);
            } else {
              _results.push(word.charAt(0).toUpperCase() + word.slice(1));
            }
          }
        }
        return _results;
      })()).join('');
    };

    ModuleInfo.prototype.element = function(selector, name, dynamic) {
      if (name == null) {
        name = null;
      }
      if (dynamic == null) {
        dynamic = false;
      }
      if (name === null) {
        name = this.constructor.selectorToName(selector);
      }
      return this._elements[name] = {
        selector: selector,
        dynamic: dynamic
      };
    };

    ModuleInfo.prototype.tree = function(treeString) {
      var line, lines, name, options, selector, _i, _len, _ref, _ref1, _results;
      lines = _(treeString.split('\n')).map($.trim).filter(function(l) {
        return l !== '';
      });
      this.root(lines.shift());
      _results = [];
      for (_i = 0, _len = lines.length; _i < _len; _i++) {
        line = lines[_i];
        _ref = _.map(line.split('/'), $.trim), selector = _ref[0], options = _ref[1];
        if (options) {
          _ref1 = options.split(/\s+/), name = _ref1[0], options = 2 <= _ref1.length ? __slice.call(_ref1, 1) : [];
          name = $.trim(name);
          options = _.map(options, $.trim);
        } else {
          name = null;
          options = [];
        }
        _results.push(this.element(selector, name, __indexOf.call(options, 'dynamic') >= 0));
      }
      return _results;
    };

    ModuleInfo.prototype.events = function(eventsString) {};

    ModuleInfo.prototype.modulesEvents = function(modulesEventsString) {};

    ModuleInfo.prototype.globalEvents = function(globalEventsString) {};

    ModuleInfo.prototype.defaultSettings = function(newDefaultSettings) {
      return $.extend(this._defaultSettings, newDefaultSettings);
    };

    ModuleInfo.prototype.expectSettings = function() {
      var expectedSettings;
      expectedSettings = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
      return this._expectedSettings = _.union(this._expectedSettings, _.flatten(expectedSettings));
    };

    ModuleInfo.prototype.dependsOn = function() {
      var moduleNames;
      moduleNames = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    };

    ModuleInfo.prototype["extends"] = function(moduleName) {};

    ModuleInfo.prototype.eventPrefix = function(prefix) {
      return this._eventPrefix = prefix;
    };

    return ModuleInfo;

  })();

  lastNameId = 0;

  genName = function() {
    return "LambdaModule" + (lastNameId++);
  };

  buildModule = function(moduleName, builder) {
    var currentScope, element, info, lambdaModule, name, newModule, part, parts, theName, value, _i, _len, _ref, _ref1;
    if (builder === void 0) {
      builder = moduleName;
      moduleName = genName();
      lambdaModule = true;
    }
    info = new ModuleInfo(moduleName);
    builder(info);
    newModule = (function(_super) {

      __extends(_Class, _super);

      function _Class() {
        return _Class.__super__.constructor.apply(this, arguments);
      }

      return _Class;

    })(BaseModule);
    newModule.NAME = moduleName;
    newModule.LAMBDA = !!lambdaModule;
    newModule.DEFAULT_SETTINGS = info._defaultSettings;
    newModule.EVENT_PREFIX = info._eventPrefix || moduleName;
    newModule.ROOT_SELECTOR = info._rootSelector;
    newModule.ELEMENTS = info._elements;
    newModule.EXPECTED_SETTINGS = info._expectedSettings;
    _ref = info._methods;
    for (name in _ref) {
      value = _ref[name];
      newModule.prototype[name] = value;
    }
    _ref1 = newModule.ELEMENTS;
    for (name in _ref1) {
      element = _ref1[name];
      if (element.dynamic) {
        (function(name, element) {
          return newModule.prototype[name] = function() {
            return this.find(element.selector);
          };
        })(name, element);
      } else {
        newModule.prototype[name] = $();
      }
    }
    modules[moduleName] = newModule;
    if (!lambdaModule) {
      parts = moduleName.split('.');
      currentScope = window;
      theName = parts.pop();
      for (_i = 0, _len = parts.length; _i < _len; _i++) {
        part = parts[_i];
        if (currentScope[part] === void 0) {
          currentScope[part] = {};
        }
        currentScope = currentScope[part];
      }
      currentScope[theName] = newModule;
    }
    return newModule;
  };

  modulesAPI = {
    find: function(moduleName) {
      return moduleInstances[moduleName] || [];
    },
    on: function(moduleName, eventName, callback) {
      return $(document).on(modules[moduleName].fixEventName(eventName), function(e) {
        var moduleInstance;
        moduleInstance = $(e.target).modules(moduleName)[0];
        if (moduleInstance) {
          callback(moduleInstance);
        }
        return true;
      });
    },
    initAll: function(context) {
      var Module, el, name, _i, _len, _results;
      _results = [];
      for (Module = _i = 0, _len = modules.length; _i < _len; Module = ++_i) {
        name = modules[Module];
        if (Module.ROOT_SELECTOR !== null && Module.INIT === 'load') {
          _results.push((function() {
            var _j, _len1, _ref, _results1;
            _ref = $(Module.ROOT_SELECTOR, context);
            _results1 = [];
            for (_j = 0, _len1 = _ref.length; _j < _len1; _j++) {
              el = _ref[_j];
              _results1.push(new Module($(el)));
            }
            return _results1;
          })());
        }
      }
      return _results;
    }
  };

  jqueryPlugin = function(moduleName) {
    var el, _i, _len, _results;
    _results = [];
    for (_i = 0, _len = this.length; _i < _len; _i++) {
      el = this[_i];
      _results.push($(el).data(moduleName));
    }
    return _results;
  };

  $(function() {
    return modulesAPI.initAll(document);
  });

  $(document).on('html-inserted', function(e) {
    return modulesAPI.initAll(e.target);
  });

  window.module = buildModule;

  window.modules = modulesAPI;

  jQuery.prototype.modules = jqueryPlugin;

  jQuery.prototype.htmlInserted = function() {
    return this.trigger('html-inserted');
  };

  action = function() {
    var args;
    args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    return $(function() {
      var a, callback;
      callback = args.pop();
      if (action.matcher((function() {
        var _i, _len, _results;
        _results = [];
        for (_i = 0, _len = args.length; _i < _len; _i++) {
          a = args[_i];
          _results.push(a.split('#'));
        }
        return _results;
      })())) {
        return callback();
      }
    });
  };

  action.matcher = function(actions) {
    var a, selector;
    selector = ((function() {
      var _i, _len, _results;
      _results = [];
      for (_i = 0, _len = actions.length; _i < _len; _i++) {
        a = actions[_i];
        _results.push("body.controller-" + a[0] + ".action-" + a[1]);
      }
      return _results;
    })()).join(', ');
    return $(selector).length > 0;
  };

  window.action = action;

}).call(this);
