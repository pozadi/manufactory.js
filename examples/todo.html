<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ToDo (manufactory.js example)</title>
  <script src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.2/underscore-min.js"></script>
  <script src="../manufactory.js"></script>
  <script src="http://coffeescript.org/extras/coffee-script.js"></script>

  <script type="text/coffeescript">
    manufactory.module 'Todos', (M) ->
      # Готовая интсрукция,
      # что написать в HTML чтобы добавить модуль на страницу:
      M.tree """
        .js-todos
          .js-clear-button
          .js-item-list
            .js-item / dynamic
              .js-item-checkbox
          .js-add-form
            .js-new-item-text
      """
      # Все события в одном месте, круто!
      M.events """
        submit addForm onSubmit
        change itemCheckbox toggleItem
        click clearButton clear
      """
      # Говорим какие настройки мы ожидаем ...
      M.expectSettings 'template'
      # ... и какие будут значения по умолчанию.
      M.defaultSettings 
        template: 'todos-item-template'
      M.methods
        # Кстати, `initializer` это новый `constructor`.
        initializer: ->
          # Мы сказали что ждем настройку `template`,
          # так что ее взяли из `data-template`, и дали нам в `@settings.template`.
          @template = _.template $('#' + @settings.template).html()
          @add 'Nothing'
        add: (text) ->
          newItem = $ @template {text}
          # Мы объявили, что будем работать с элементом `.js-item-list`,
          # и нам дали готовую переменную `@itemList` — магия!
          @itemList.append newItem
        onSubmit: ->
          @add @newItemText.val()
          @newItemText.val ''
          return false
        toggleItem: (checkbox) ->
          # В обработчике `this` — это ссылка на объект модуля,
          # а то, что раньше было в `this` — элемент, идет первым параметром.
          item = $(checkbox).parents '.js-item'
          item.toggleClass 'done', $(checkbox).prop 'checked'
        clear: ->
          @item().filter('.done').remove()
  </script>

  <style type="text/css">
    h1 small {
      cursor: pointer;
      border-bottom: dashed 1px;
      font-weight: normal;
      font-size: 50%;
      vertical-align: middle;
    }
    .done {
      text-decoration: line-through;
      opacity: .5;
    }
  </style>

</head>
<body>
  
  <script type="text/html" id=todos-item-template2>
    <li class=js-item>
      <label><input type=checkbox class=js-item-checkbox> <%= text %></label>
    </li>
  </script>

  <!-- По умолчанию используется `#todos-item-template`, 
       но мы хотим `#todos-item-template2`. Настройки в дейтвии, ха! -->
  <div class=js-todos data-template=todos-item-template2>
    <h1>ToDo <small class=js-clear-button>Clear completed</small></h1>
    <ol class=js-item-list></ol>
    <form class=js-add-form>
      <input type=text placeholder="Good stuff" class=js-new-item-text>
      <input type=submit value=Add>
    </form>
  </div>

</body>
</html>